<!DOCTYPE html>
<html>
<head>
    <title>Status do V√≠deo - Text-to-Video AI</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .btn {
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background: #218838;
        }
        .btn-primary {
            background: #007bff;
        }
        .btn-primary:hover {
            background: #0056b3;
        }
        .progress {
            background: #f0f0f0;
            border-radius: 10px;
            height: 30px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.5s ease;
        }
        .status-badge {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
            display: inline-block;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .step-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            transition: all 0.3s ease;
        }
        .step-item.completed {
            background: rgba(40, 167, 69, 0.2);
            border-left: 4px solid #28a745;
        }
        .step-item.current {
            background: rgba(0, 123, 255, 0.2);
            border-left: 4px solid #007bff;
        }
        .step-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
        }
        .step-icon.completed {
            background: #28a745;
            color: white;
        }
        .step-icon.current {
            background: #007bff;
            color: white;
        }
        .step-icon.pending {
            background: #6c757d;
            color: white;
        }
        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öôÔ∏è Status do V√≠deo</h1>
        <p>Acompanhe a gera√ß√£o do seu v√≠deo em tempo real</p>
        
        <div style="margin-bottom: 30px;">
            <a href="/" class="btn">üè† In√≠cio</a>
            <a href="/gallery" class="btn">üìÅ Galeria</a>
            <a href="/api/jobs" class="btn" target="_blank">üîß API</a>
        </div>

        <div id="statusContainer">
            <div style="text-align: center; padding: 50px;">
                <div style="font-size: 3rem; margin-bottom: 20px;">‚è≥</div>
                <h3>Carregando status...</h3>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const jobId = '{{ job_id }}';
        let socket = io();
        let currentStatus = 'PENDING';

        // Connect to WebSocket
        socket.emit('subscribe_job', { job_id: jobId });

        // Load initial status
        document.addEventListener('DOMContentLoaded', function() {
            loadJobStatus();
        });

        async function loadJobStatus() {
            try {
                const response = await fetch(`/api/jobs/${jobId}`);
                const job = await response.json();
                
                if (response.ok) {
                    updateStatusDisplay(job);
                } else {
                    showError('Job n√£o encontrado');
                }
            } catch (error) {
                console.error('Erro ao carregar status:', error);
                showError('Erro ao carregar status do job');
            }
        }

        function updateStatusDisplay(job) {
            const container = document.getElementById('statusContainer');
            
            const progressPercent = job.progress || 0;
            const status = job.status || 'PENDING';
            currentStatus = status;

            const steps = [
                { name: 'Iniciando gera√ß√£o', icon: 'üöÄ', progress: 10 },
                { name: 'Gerando script', icon: 'üìù', progress: 20 },
                { name: 'Gerando √°udio', icon: 'üé§', progress: 40 },
                { name: 'Gerando legendas', icon: 'üì∫', progress: 60 },
                { name: 'Buscando v√≠deos de fundo', icon: 'üé¨', progress: 80 },
                { name: 'Renderizando v√≠deo final', icon: '‚öôÔ∏è', progress: 90 },
                { name: 'Finalizando', icon: '‚úÖ', progress: 100 }
            ];

            const currentStep = Math.floor(progressPercent / 15);
            
            const stepsHtml = steps.map((step, index) => {
                let stepClass = 'pending';
                let iconClass = 'pending';
                
                if (index < currentStep) {
                    stepClass = 'completed';
                    iconClass = 'completed';
                } else if (index === currentStep) {
                    stepClass = 'current';
                    iconClass = 'current';
                }

                return `
                    <div class="step-item ${stepClass}">
                        <div class="step-icon ${iconClass}">
                            ${step.icon}
                        </div>
                        <div>
                            <h4 style="margin: 0;">${step.name}</h4>
                            <small style="opacity: 0.8;">${step.progress}%</small>
                        </div>
                    </div>
                `;
            }).join('');

            const statusText = getStatusText(status);
            const statusIcon = getStatusIcon(status);

            container.innerHTML = `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="margin: 0;">üé¨ ${job.topic || 'V√≠deo'}</h2>
                        <span class="status-badge status-${status.toLowerCase()}">
                            ${statusIcon} ${statusText}
                        </span>
                    </div>

                    <div class="progress">
                        <div class="progress-bar" style="width: ${progressPercent}%"></div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                        <span id="progressText">${getProgressText(progressPercent, status)}</span>
                        <span id="progressPercent">${progressPercent}%</span>
                    </div>

                    <div style="margin: 20px 0; font-size: 14px; opacity: 0.8;">
                        <div>üìÖ Criado: ${new Date(job.created_at).toLocaleDateString('pt-BR')}</div>
                        <div>üïê Atualizado: ${new Date(job.updated_at).toLocaleTimeString('pt-BR')}</div>
                    </div>

                    <div style="margin: 30px 0;">
                        <h3>üìã Etapas do Processo</h3>
                        ${stepsHtml}
                    </div>

                    ${status === 'COMPLETED' ? `
                        <div style="text-align: center; margin-top: 30px;">
                            <a href="/api/videos/${jobId}" class="btn">‚¨áÔ∏è Baixar V√≠deo</a>
                            <a href="/gallery" class="btn btn-primary">üìÅ Ver Galeria</a>
                        </div>
                    ` : ''}

                    ${status === 'FAILED' ? `
                        <div class="error-message">
                            <h4>‚ùå Erro na gera√ß√£o:</h4>
                            <p>${job.error || 'Erro desconhecido'}</p>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function getStatusText(status) {
            const texts = {
                'PENDING': 'Aguardando',
                'PROCESSING': 'Processando',
                'COMPLETED': 'Conclu√≠do',
                'FAILED': 'Falhou'
            };
            return texts[status] || status;
        }

        function getStatusIcon(status) {
            const icons = {
                'PENDING': '‚è≥',
                'PROCESSING': '‚öôÔ∏è',
                'COMPLETED': '‚úÖ',
                'FAILED': '‚ùå'
            };
            return icons[status] || '‚ÑπÔ∏è';
        }

        function getProgressText(progress, status) {
            if (status === 'COMPLETED') return 'V√≠deo gerado com sucesso!';
            if (status === 'FAILED') return 'Erro na gera√ß√£o';
            if (progress < 20) return 'Iniciando gera√ß√£o...';
            if (progress < 40) return 'Gerando script...';
            if (progress < 60) return 'Gerando √°udio...';
            if (progress < 80) return 'Gerando legendas...';
            if (progress < 90) return 'Buscando v√≠deos de fundo...';
            return 'Renderizando v√≠deo final...';
        }

        function showError(message) {
            document.getElementById('statusContainer').innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3>Erro</h3>
                    <p>${message}</p>
                    <a href="/" class="btn">üè† Voltar ao In√≠cio</a>
                </div>
            `;
        }

        // Socket events
        socket.on('job_update', function(data) {
            if (data.job_id === jobId) {
                loadJobStatus();
            }
        });

        socket.on('job_completed', function(data) {
            if (data.job_id === jobId) {
                setTimeout(() => {
                    loadJobStatus();
                }, 1000);
            }
        });

        socket.on('job_failed', function(data) {
            if (data.job_id === jobId) {
                setTimeout(() => {
                    loadJobStatus();
                }, 1000);
            }
        });

        // Auto-refresh every 5 seconds if not completed
        setInterval(() => {
            if (currentStatus !== 'COMPLETED' && currentStatus !== 'FAILED') {
                loadJobStatus();
            }
        }, 5000);
    </script>
</body>
</html> 